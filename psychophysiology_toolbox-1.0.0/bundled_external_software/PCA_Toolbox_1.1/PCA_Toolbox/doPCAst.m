function [FacPatST, FacStrST, FacScrST, FacRefST, FacCorST, screeST, facVarST, facVarQST, varSDST] = doPCAst(ROTATION, MAT_TYPE, NUM_FAC, FacScr, KAISER, facVar, facVarQ, FacPat, varSD, NUM_VAR);% doPCAst - [FacPatST, FacPatST, FacStrST, FacScrST, FacRefST, FacCorST, screeST, facVarST, facVarQST, varSDST] = doPCAst(ROTATION, MAT_TYPE, NUM_FAC, FacScr, KAISER, facVar, facVarQ, FacPat, varSD, NUM_VAR);%Inputs%  ROTATION	: Type of rotation (VMAX:varimax or PMAX: promax or UNRT: unrotated or ICA: IMAX)%               ICA is run with the PCA subspace option on by default.  This program can be edited to change its options.%               Output is rescaled to be consistent with PCA conventions.%  MAT_TYPE	: Matrix type (SCP: sums-of-squares-cross-product matrix, COV: variance-covariance matrix, COR: correlation matrix)%  NUM_FAC	: Number of factors retained%  FacScr	: Data matrix (observations, factors)%  KAISER	: Kaiser normalization ('K' Kaiser normalization, 'N' no Kaiser normalization, 'C' covariance loadings).%  FacVar	: %age of variance accounted for by each input factor, ignoring other factors.%  FacVarQ	: %age of variance uniquely accounted for by each input factor.%  FacPat	: Factor pattern matrix from 1st PCA step - produces standardized variables from scores, scaled by communality  (variables, factors)%  varSD	: Standard deviations of the variables prior to the input PCA decomposition%  NUM_VAR	: Size of the mode to be factored next (timepoints if spatio-temporal, channels if temporo-spatial).%Outputs%  FacPatST	: Promax factor pattern matrix - produces standardized variables from scores, scaled by communality  (variables, factors)%  FacStrST	: Promax factor structure matrix - correlation between factors and variables (variables, factors)%  FacScrST	: Promax factor scores, variance standardized, non-mean corrected (observations: cells*subjects, factors)%  FacRefST	: Promax reference vector - correlation of factor with variables with variance from other factors eliminated (variables, factors)%  FacCorST	: Promax factor correlations%  screeST    : The full set of unrotated eigenvalues, prior to truncation, for each input factor (output factors, input factors)%  facVarST   : %age of variance accounted for by each Promax rotated factor, ignoring other factors (based on PmxStr)%			  Calculated based on variance of relationship matrix (if COV or SCP, each variable weighted)%  facVarQST  : %age of variance uniquely accounted for by each Promax rotated factor, (based on PmxRef)%			  Calculated based on variance of relationship matrix (if COV or SCP, each variable weighted)%  varSDST    : Standard deviations of the variables prior to the second PCA.%%  Based on doPCA.m.  Takes output of doPCA and performs a PCA on the factor scores in order to produce a spatiotemporal%  or temporospatial PCA result.  A global number of factors is specified for the second stage PCA to keep things simple since%  the statistics literature indicates the overretention of factors does not notably degrade solutions.%  The resulting output has the same structure as the input data but with the number of factors multiplied by the%  second stage factors.  The second stage factors vary most quickly (e.g.,%  for temporospatial PCA, T1S1 T1S2 T1S3...T2S1...etc.).%History%  by Joseph Dien (1/10/01)%  University of Kansas%  jdien@ku.edu%%  Modified (2/28/01) JD%  Altered input names to facilitate use.%%  Modified (3/2/01)  JD%  Dropped scoring coefficient output to avoid singularity problems when calculating it.%%  modified 7/27/02 JD%  Implemented non mean-corrected factor scores.  Factor score output no longer has 1st stage factor patterns reintroduced.%%  modified 8/4/02 JD%  Output generalized so that type of rotation can be specified.%%  modified 10/26/03 JD%  Added option for unscaled loadings during rotation (not for Infomax).  Set Infomax%  rotation to automatically use covariance matrix (i.e., mean-corrected%  but not variance-corrected variables).%%  modified 3/23/04 JD%  Folded LOADINGS option for covariance loadings into Kaiser parameter%  since they're alternatives to each other.%%  bugfix 10/24/06 JD%  If facVarQ is empty, as for current Infomax code, just don't calculate%  it for the ST analysis.%     Copyright (C) 1999-2008  Joseph Dien% %     This program is free software: you can redistribute it and/or modify%     it under the terms of the GNU General Public License as published by%     the Free Software Foundation, either version 3 of the License, or%     (at your option) any later version.% %     This program is distributed in the hope that it will be useful,%     but WITHOUT ANY WARRANTY; without even the implied warranty of%     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the%     GNU General Public License for more details.% %     You should have received a copy of the GNU General Public License%     along with this program.  If not, see <http://www.gnu.org/licenses/>.disp('ERP PCA Toolbox 1.1  Copyright (C) 1999-2008  Joseph Dien');disp('This program comes with ABSOLUTELY NO WARRANTY.');disp('This is free software, and you are welcome to redistribute it');disp('under certain conditions; see http://www.gnu.org/licenses/ for details.');FacPatST=[];FacStrST=[];FacScrST=[];FacRefST=[];FacCorST=[];screeST=[];facVarST=[];facVarQST=[];varSDST=[];for factor = 1:size(FacScr,2)	%input factors    data = reshape(FacScr(:,factor),NUM_VAR,(size(FacScr,1)/NUM_VAR))';	%reshape factor vector so that the second mode is now the variables    disp(['FACTOR #' num2str(factor)]);    [stFacPat, stFacStr, stFacScr, stFacRef, stFacCor, stscree, stfacVar, stfacVarQ, stvarSD] = doPCA('asis',ROTATION, MAT_TYPE, NUM_FAC, data, KAISER);    FacPatST=[FacPatST stFacPat];    FacStrST=[FacStrST stFacStr];    FacScrST=[FacScrST stFacScr];    FacRefST=[FacRefST stFacRef];    FacCorST=[FacCorST stFacCor];    screeST=[screeST stscree];    facVarST = [facVarST; (facVar(factor) .* stfacVar)];    if ~isempty(facVarQ)        facVarQST = [facVarQST; (facVarQ(factor) .* stfacVarQ)];    end;    varSDST=[varSDST; stvarSD];end